---
title: Code Formatting and Highlighting
author: CWiki
date: 02/27/2018 09:46:04 AM 
updated: 03/01/2018 05:52:26 PM
tags:
  - technical note
  - text formatting
  - cwiki
---

Markdown has a few ways to format code built in. In order to get it to look right, you probably have to fiddle with the CSS of the site. It isn't a perfectly straightforward problem.

## Methods of Formatting Code ##

You can use the backtick ("\`", also known formally as a "grave accent") to format `code inline` like that. For blocks of code, you can simply indent each line with four spaces.

    (defn ex
      [an-arg]
      (let [an-array [1 3 37]
            a-set #{"a" "b" "c"}
            a-map {:key-one "Something" :key-two "Else" :a-really-long-key "to see what happens with overflow"}]
        (+ an-arg (second an-array))))
    => #'user/ex
    (ex 14)
    => 17

You can use the `<pre></pre>` tags directly to do something similar.

<pre>
(defn ex
  [an-arg]
  (let [an-array [1 3 37]
        a-set #{"a" "b" "c"}
        a-map {:key-one "Something" :key-two "Else" :a-really-long-key "to see what happens with overflow"}]
    (+ an-arg (second an-array))))
=> #'user/ex
(ex 14)
=> 17
</pre>

But the `<pre>` tags by themselves are often used for things other than code blocks. For example, sections of text where you don't want text wrapping to occur, like some CSV data or a haiku[^1].

<pre>
In the twilight rain
these brilliant-hued hibiscus -
A lovely sunset.
</pre>

CSS for `<pre>` tags should not assume that there will be a code block within the tags unless it includes some special class that handles it.

[GFM](https://github.github.com/gfm/) offers the convenience of what it calls "fenced code blocks" using a triple backtick ("\`\`\`") before and after the code block -- no indenting is required.

```
(defn ex
  [an-arg]
  (let [an-array [1 3 37]
        a-set #{"a" "b" "c"}
        a-map {:key-one "Something" :key-two "Else" :a-really-long-key "to see what happens with overflow"}]
    (+ an-arg (second an-array))))
=> #'user/ex
(ex 14)
=> 17
```

And then there are syntax highlighters to throw into the mix.

### Syntax Highlighting ###

The final piece of the puzzle is the inclusion of syntax highlighting for code blocks. Most of the syntax highlighters that I am aware of work with the GFM triple backtick form of demarcating code blocks.

The difficulty comes in because all of the highlighters do not use the same syntax to indicate that highlighting should occur or the programming language within the code block.

Picking a syntax highlighter to use with CWiki was a bit of a puzzler. There was no problem in handling highlighting within the wiki, but what about documents imported and exported from the wiki? Those could come from anywhere, like blog posts or `readme` files. They might be exported for use in the same types of documents as well. Blogs and code repositories don't all do highlighting the same way.

In the end, I decided to use Google's [`code-prettify`](https://github.com/google/code-prettify).

* It's used by Google, of course, and Stack Overflow.
* It works with lots of languages.
* It's themable.

## Use Cases ##

Given the above, there are several use cases that the CSS must cover.

* Inline code fragments like `this` generated by the single backtick method.
* Non-code, preformatted text surrounded by `<pre></pre>` tags.
* Code listings produced by indenting a code block.
* Code blocks surrounded by the triple backticks.
* Code blocks surrounded by triple backticks intended to be further processed by a syntax highlighter.

## Making the CSS Work ##

The CSS used for these situations must look nice and handle the interactions gracefully.

### Inline Code ###

The inline backticks are pretty easy. The get transformed to `<code></code>` tags surrounding the included text. CSS for the `<code>` tag will take care of the formatting of the inline code.

For this, I use CSS to select from a family of fixed-width fonts, give it a size, color, and background color. Adust margins and padding so it doesn't mess up the line spacing for "normal" text surrounding it. You can see the results in the paragraph above.

### Pre-formatted Text ###

Items wrapped in the `<pre></pre>` tags should be left pretty much alone. Just apply the same formatting as inline code, but for a block.

### Indented Code Blocks ###

The code blocks that are indented four spaces get surrounded by `<pre><code></code></pre>` tags. GFM fenced code blocks produce the same HTML. So a CSS descendant selector of the form 

    pre code {
        ...
    }

should do the trick.

### Fenced Code Blocks ###

Since `code-prettify` can do automatic language recognition from the code within the block, you can start with something like:

```
    ```prettyprint
    some code here...
    ```
```

Which produces:

```prettyprint
(defn ex
  [an-arg]
  (let [an-array [1 3 37]
        a-set #{"a" "b" "c"}
        a-map {:key-one "Something" :key-two "Else" :a-really-long-key "to see what happens with overflow"}]
    (+ an-arg (second an-array))))
=> #'user/ex
(ex 14)
=> 17
```

This generates a 

```
<pre>
    <code class="language-prettyprint prettyprinted" style="">
        ...
    </code>
</pre>`
```

HTML block.

If your language isn't recognized automatically, you can be more explicit. Using

```
    ```prettyprint lang-clj
    some code here...
    ```
```

will give something like

```prettyprint lang-clj
(defn ex
  [an-arg]
  (let [an-array [1 3 37]
        a-set #{"a" "b" "c"}
        a-map {:key-one "Something" :key-two "Else" :a-really-long-key "to see what happens with overflow"}]
    (+ an-arg (second an-array))))
=> #'user/ex
(ex 14)
=> 17
```

This is a useful tactic if your code block is to short for `code-prettify` to do a reliable recognition. 

For this example, it produces exactly the same class definition as above. So, if you want to specialize the CSS when you have a pretty printed block, you might want to have some CSS for the `prettyprinted` class. CWiki does not do this.

[^1]: [This haiku was written by Basho Matsuo (1644-1694) and copied from "Examples of Haiku Poems" on steemit.com](http://examples.yourdictionary.com/examples-of-haiku-poems.html)

